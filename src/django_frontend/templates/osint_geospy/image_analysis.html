{% extends 'base.html' %}

{% block title %}DRONE OSINT GEOSPY - Image Analysis{% endblock %}

{% block extra_css %}
<style>
  #mapbox {
    width: 100%;
    height: 500px;
    border-radius: 5px;
  }
</style>
{% endblock %}

{% block content %}
<div class="analysis-section">
    <h2>
        <i class="fas fa-eye me-2"></i> TERRAIN INTELLIGENCE ANALYSIS
    </h2>
    
    <!-- Location Search Section -->
    <div class="info-box mb-4">
        <h3 class="mb-3">üîç SEARCH LOCATION</h3>
        
        <form method="POST" action="{% url 'osint_geospy:search_location' %}">
            {% csrf_token %}
            <div class="row g-3 align-items-center">
                <div class="col-md-8">
                    <input type="text" class="form-control" name="location_search" id="location_search" 
                           placeholder="Enter location (city, address, landmark)" required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-military w-100">
                        <i class="fas fa-search me-2"></i> SEARCH
                    </button>
                </div>
            </div>
        </form>
        
        {% if request.session.location_results %}
            <div class="mt-3">
                <h4 class="text-warning">SEARCH RESULTS:</h4>
                
                <select class="form-select mb-3" id="location_select" aria-label="Select a location from search results">
                    <option value="">Select a location</option>
                    {% for result in request.session.location_results %}
                        <option value="{{ result.longitude }},{{ result.latitude }}">
                            {{ result.place_name }} [{{ result.longitude|floatformat:6 }}, {{ result.latitude|floatformat:6 }}]
                        </option>
                    {% endfor %}
                </select>
                
                <div id="selected_location_details" class="mb-3" style="display:none;">
                    <p><strong>SELECTED:</strong> <span id="place_name"></span></p>
                    <p><strong>COORDINATES:</strong> <span id="coordinates"></span></p>
                    
                    <button id="show_location_map" class="btn btn-military">
                        <i class="fas fa-map-marker-alt me-2"></i> SHOW ON MAP
                    </button>
                </div>
                
                <div id="location_map_container" class="map-container mt-3" style="display:none;">
                    <h3>LOCATION MAP</h3>
                    <div id="mapbox"></div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <hr class="military-hr">
    
    <!-- File Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h3 class="mb-3">
                <i class="fas fa-upload me-2"></i> UPLOAD RECONNAISSANCE IMAGE
            </h3>
            
            <form method="POST" action="{% url 'osint_geospy:analyze_image' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="image_upload" class="custom-file-upload">
                    <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                    <p class="mb-0">Drop image here or click to browse</p>
                    <small>Supported formats: JPG, JPEG, PNG</small>
                </label>
                <input id="image_upload" name="image" type="file" accept=".jpg,.jpeg,.png" style="display:none;" onchange="showFileName(this)">
                
                <div id="file_info" class="info-box mb-3" style="display:none;">
                    <p class="mb-1"><strong>SELECTED FILE:</strong> <span id="filename"></span></p>
                    <p class="mb-0"><strong>SIZE:</strong> <span id="filesize"></span></p>
                </div>
                
                <button type="submit" class="btn btn-military w-100">
                    <i class="fas fa-crosshairs me-2"></i> ANALYZE TERRAIN
                </button>
            </form>
        </div>
    </div>
    
    {% if request.session.current_image_id %}
        {% for image in recent_images %}
            {% if image.image_id|stringformat:"s" == request.session.current_image_id %}
                <h2>
                    <i class="fas fa-chart-bar me-2"></i> INTELLIGENCE REPORT
                </h2>
                
                <div class="row">
                    <div class="col-md-7">
                        <div class="card-military mb-4">
                            <div class="card-header">
                                <h3 class="mb-0">VISUAL INTELLIGENCE</h3>
                            </div>
                            <div class="card-body text-center">
                                <img src="{{ image.image.url }}" class="img-fluid rounded" alt="Drone image">
                            </div>
                        </div>
                        
                        {% if image.latitude and image.longitude %}
                            <div class="map-container">
                                <h3>GEOLOCATION DATA</h3>
                                <div id="analysis_map" 
                                     data-latitude="{{ image.latitude }}" 
                                     data-longitude="{{ image.longitude }}"
                                     style="width:100%; height:400px;">
                                </div>
                            </div>
                            
                            <!-- New conversation box -->
                            <div class="card-military mt-4">
                                <div class="card-header">
                                    <h3 class="mb-0">IMAGE INTERROGATION</h3>
                                </div>
                                <div class="card-body">
                                    <div class="chat-container mb-3" style="height: 200px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 5px;">
                                        <div class="assistant-message">
                                            <strong>MISSION INTELLIGENCE SYSTEM READY</strong><br>
                                            You can ask questions about this image, its geolocation data, or request analysis of specific features.
                                        </div>
                                        
                                        <div id="chat-messages">
                                            <!-- Messages will appear here -->
                                        </div>
                                        
                                        <div id="typing-indicator" class="assistant-message" style="display:none;">
                                            <div class="typing-animation">
                                                <span class="dot"></span>
                                                <span class="dot"></span>
                                                <span class="dot"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <form id="chat-form" class="mb-0">
                                        <div class="input-group">
                                            <input type="text" id="message-input" class="form-control" 
                                                placeholder="Ask a question about this image..." required>
                                            <button type="submit" class="btn btn-military">
                                                <i class="fas fa-paper-plane me-2"></i> SEND
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-5">
                        <div class="card-military mb-4">
                            <div class="card-header">
                                <h3 class="mb-0">IMAGE DETAILS</h3>
                            </div>
                            <div class="card-body">
                                <p><strong>FILENAME:</strong> {{ image.title }}</p>
                                <p><strong>UPLOAD TIME:</strong> {{ image.uploaded_at|date:"Y-m-d H:i:s" }}</p>
                                
                                {% if image.camera_make or image.camera_model %}
                                    <p><strong>CAMERA:</strong> {{ image.camera_make }} {{ image.camera_model }}</p>
                                {% endif %}
                                
                                {% if image.analyzed %}
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i> Analysis completed
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-spinner fa-spin me-2"></i> Analysis in progress
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if image.analyzed and image.results.all %}
                            {% with result=image.results.first %}
                                <div class="card-military mb-4">
                                    <div class="card-header">
                                        <h3 class="mb-0">LOCATION ANALYSIS</h3>
                                    </div>
                                    <div class="card-body">
                                        {% if result.country or result.city %}
                                            <p>
                                                <strong>LOCATION:</strong> 
                                                {{ result.city }}{% if result.city and result.country %}, {% endif %}
                                                {{ result.country }}
                                            </p>
                                        {% endif %}
                                        
                                        {% if result.neighborhood %}
                                            <p><strong>NEIGHBORHOOD:</strong> {{ result.neighborhood }}</p>
                                        {% endif %}
                                        
                                        {% if result.street %}
                                            <p><strong>STREET:</strong> {{ result.street }}</p>
                                        {% endif %}
                                        
                                        {% if image.latitude and image.longitude %}
                                            <div class="coordinates mb-3">
                                                LAT: {{ image.latitude|floatformat:6 }} | LON: {{ image.longitude|floatformat:6 }}
                                            </div>
                                        {% endif %}
                                        
                                        <p><strong>CONFIDENCE:</strong> {{ result.confidence|upper }}</p>
                                    </div>
                                </div>
                                
                                {% if result.description %}
                                    <div class="card-military mb-4">
                                        <div class="card-header">
                                            <h3 class="mb-0">AI ANALYSIS</h3>
                                        </div>
                                        <div class="card-body">
                                            <p>{{ result.description }}</p>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if result.architectural_features or result.landscape_features %}
                                    <div class="card-military">
                                        <div class="card-header">
                                            <h3 class="mb-0">DETECTED FEATURES</h3>
                                        </div>
                                        <div class="card-body">
                                            {% if result.architectural_features %}
                                                <h5 class="text-warning">ARCHITECTURAL:</h5>
                                                <ul>
                                                    {% for feature in result.architectural_features %}
                                                        <li>{{ feature }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                            
                                            {% if result.landscape_features %}
                                                <h5 class="text-warning">LANDSCAPE:</h5>
                                                <ul>
                                                    {% for feature in result.landscape_features %}
                                                        <li>{{ feature }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Show selected file info
    function showFileName(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            document.getElementById('filename').textContent = file.name;
            document.getElementById('filesize').textContent = (file.size / 1024).toFixed(1) + ' KB';
            document.getElementById('file_info').style.display = 'block';
        }
    }
    
    // Location result selection
    document.addEventListener('DOMContentLoaded', function() {
        const locationSelect = document.getElementById('location_select');
        const detailsDiv = document.getElementById('selected_location_details');
        const placeName = document.getElementById('place_name');
        const coordinatesSpan = document.getElementById('coordinates');
        const showMapBtn = document.getElementById('show_location_map');
        const mapContainer = document.getElementById('location_map_container');
        
        if (locationSelect) {
            locationSelect.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    placeName.textContent = selectedOption.text.split(' [')[0];
                    coordinatesSpan.textContent = this.value;
                    detailsDiv.style.display = 'block';
                } else {
                    detailsDiv.style.display = 'none';
                }
            });
            
            if (showMapBtn) {
                showMapBtn.addEventListener('click', function() {
                    const coords = locationSelect.value.split(',');
                    if (coords.length === 2) {
                        const lon = parseFloat(coords[0]);
                        const lat = parseFloat(coords[1]);
                        
                        // Initialize Mapbox map
                        mapboxgl.accessToken = '{{ mapbox_token }}';
                        const map = new mapboxgl.Map({
                            container: 'mapbox',
                            style: 'mapbox://styles/mapbox/satellite-streets-v11',
                            center: [lon, lat],
                            zoom: 13
                        });
                        
                        // Add marker
                        new mapboxgl.Marker()
                            .setLngLat([lon, lat])
                            .addTo(map);
                        
                        mapContainer.style.display = 'block';
                    }
                });
            }
        }
        
        // Analysis map initialization using data attributes
        const analysisMap = document.getElementById('analysis_map');
        if (analysisMap && analysisMap.dataset.latitude && analysisMap.dataset.longitude) {
            const lat = parseFloat(analysisMap.dataset.latitude);
            const lon = parseFloat(analysisMap.dataset.longitude);
            
            mapboxgl.accessToken = '{{ mapbox_token }}';
            const map = new mapboxgl.Map({
                container: 'analysis_map',
                style: 'mapbox://styles/mapbox/satellite-streets-v11',
                center: [lon, lat],
                zoom: 13
            });
            
            // Add marker
            new mapboxgl.Marker()
                .setLngLat([lon, lat])
                .addTo(map);
        }

        // Chat functionality
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');

        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const message = messageInput.value.trim();
                if (message) {
                    // Add user message to chat
                    const userMessageElement = document.createElement('div');
                    userMessageElement.className = 'user-message';
                    userMessageElement.textContent = message;
                    chatMessages.appendChild(userMessageElement);
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Show typing indicator
                    typingIndicator.style.display = 'block';
                    
                    // Auto-scroll to bottom
                    const chatContainer = userMessageElement.parentElement.parentElement;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                    // Get the current image ID from the URL or data attribute
                    {% for image in recent_images %}
                        {% if image.image_id|stringformat:"s" == request.session.current_image_id %}
                            const imageId = '{{ image.image_id }}';
                        {% endif %}
                    {% endfor %}
                    
                    // Call the backend API using fetch
                    fetch('{% url "osint_geospy:chat_with_image" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            message: message,
                            image_id: imageId
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Hide typing indicator
                        typingIndicator.style.display = 'none';
                        
                        // Create AI response element
                        const aiMessageElement = document.createElement('div');
                        aiMessageElement.className = 'assistant-message';
                        
                        if (data.success) {
                            aiMessageElement.innerHTML = data.response;
                        } else {
                            // Mensaje amigable para errores espec√≠ficos
                            if (data.error && (data.error.includes('backend') || data.error.includes('Backend') || data.error.includes('ID'))) {
                                aiMessageElement.innerHTML = `<span class="text-warning">
                                    <strong>Aviso:</strong> Esta imagen fue analizada con una versi√≥n anterior del sistema.
                                    Por favor, vuelve a analizarla para habilitar el chat.
                                </span>`;
                            } else {
                                aiMessageElement.innerHTML = `<span class="text-danger">Error: ${data.error || 'Could not get a response'}</span>`;
                            }
                        }
                        
                        chatMessages.appendChild(aiMessageElement);
                        
                        // Auto-scroll to bottom
                        const chatContainer = aiMessageElement.parentElement.parentElement;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    })
                    .catch(error => {
                        // Hide typing indicator
                        typingIndicator.style.display = 'none';
                        
                        // Create error message
                        const aiMessageElement = document.createElement('div');
                        aiMessageElement.className = 'assistant-message';
                        
                        // Mostrar mensaje amigable para el error de backend_image_id
                        if (error.message.includes('backend') || error.message.includes('Backend')) {
                            aiMessageElement.innerHTML = `<span class="text-warning">
                                <strong>Aviso:</strong> Esta imagen fue analizada con una versi√≥n anterior del sistema.
                                Por favor, vuelve a analizarla para habilitar el chat.
                            </span>`;
                        } else {
                            aiMessageElement.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
                        }
                        
                        chatMessages.appendChild(aiMessageElement);
                        
                        // Auto-scroll to bottom
                        const chatContainer = aiMessageElement.parentElement.parentElement;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    });
                }
            });
        }
        
        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>

<style>
    /* Styling for chat messages */
    .user-message, .assistant-message {
        max-width: 90%;
        padding: 8px 12px;
        margin-bottom: 10px;
        border-radius: 5px;
        word-wrap: break-word;
    }
    
    .user-message {
        background-color: rgba(30, 63, 102, 0.7);
        margin-left: auto;
        border-bottom-right-radius: 0;
        text-align: right;
    }
    
    .assistant-message {
        background-color: rgba(30, 63, 32, 0.7);
        margin-right: auto;
        border-bottom-left-radius: 0;
    }
    
    /* Typing indicator animation */
    .typing-animation {
        display: inline-flex;
        align-items: center;
    }
    
    .typing-animation .dot {
        width: 6px;
        height: 6px;
        margin: 0 2px;
        background-color: #a3c653;
        border-radius: 50%;
        opacity: 0.6;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-animation .dot:nth-child(1) {
        animation-delay: 0s;
    }
    
    .typing-animation .dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-animation .dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.6;
        }
        30% {
            transform: translateY(-4px);
            opacity: 1;
        }
    }
</style>
{% endblock %} 